### 1. Khái niệm và Vai trò của CTE (Common Table Expressions)

CTE, hay còn gọi là  **mệnh đề `WITH`** , là một kỹ thuật mạnh mẽ trong SQL cho phép bạn tạo ra một  **bí danh (alias) cho toàn bộ truy vấn** .

* **Bí danh cho Truy vấn:** CTE cho phép bạn tham chiếu đến truy vấn đó trong các truy vấn tiếp theo  **giống như một bảng cơ sở dữ liệu thông thường** . Điều này đặc biệt hữu ích khi bạn cần truy vấn từ kết quả của các truy vấn tập dữ liệu tùy chỉnh.
* **Cải thiện Khả năng Đọc:** Việc sử dụng CTE giúp truy vấn chính ở cuối trở nên **sạch sẽ và dễ hiểu hơn** so với việc sử dụng subqueries (truy vấn con).
* **Thực thi:** Các truy vấn trong mệnh đề `WITH` được chạy trước khi phần còn lại của truy vấn chính bắt đầu xử lý. Tuy nhiên, cần lưu ý rằng kết quả của CTE  **không được lưu trữ vĩnh viễn** .

Nhiều hệ thống cơ sở dữ liệu, bao gồm  **MySQL kể từ phiên bản 8.0** , hỗ trợ CTE.

### 2. CTE trong Bối cảnh Báo cáo Ad-hoc và Bộ dữ liệu Phân tích

Trong quá trình  **Báo cáo Ad-hoc** , nhà phân tích hoặc nhà khoa học dữ liệu thường xây dựng các tập dữ liệu để trả lời các câu hỏi nghiệp vụ cụ thể. Một nhà phân tích có kinh nghiệm sẽ thiết kế tập dữ liệu không chỉ để trả lời câu hỏi hiện tại mà còn để **dự đoán các câu hỏi tiếp theo** (follow-up questions), từ đó làm cho bộ dữ liệu trở nên  **tái sử dụng được** .

CTE là một trong những cơ chế chính (cùng với Views) được sử dụng để **lưu trữ các truy vấn** tạo ra các tập dữ liệu phân tích tùy chỉnh này, nhằm mục đích tái sử dụng trong các báo cáo và phân tích sau này.

#### Ví dụ về Tái sử dụng cho Phân tích:

Giả sử bạn đã tạo một truy vấn phức tạp để tổng hợp doanh số theo ngày và nhà cung cấp (một "analytical dataset" tùy chỉnh). Để tạo một báo cáo tóm tắt dữ liệu này ở mức độ tổng hợp cao hơn (ví dụ: doanh số theo tuần), bạn có thể sử dụng CTE:

1. **Định nghĩa CTE:** Đặt truy vấn phức tạp (doanh số theo ngày/nhà cung cấp) vào một CTE và đặt bí danh cho nó (ví dụ: `sales_by_day_vendor`).
2. **Tái sử dụng:** Sau đó, bạn có thể viết một câu lệnh `SELECT` mới, coi `sales_by_day_vendor`  **như một bảng bình thường** , để nhóm (GROUP BY) dữ liệu theo tuần và tính tổng doanh số.

Bằng cách này, truy vấn chính trở nên ngắn gọn hơn, và logic phức tạp của việc tạo ra tập dữ liệu cấp thấp (granular) được cô lập trong CTE.

### 3. Cấu trúc Cú pháp CTE

Cú pháp cơ bản của CTE là:

```
WITH [query_alias] AS
(
[query]
),
[query_2_alias] AS
(
[query_2]
)
SELECT [column list]
FROM [query_alias]
... [phần còn lại của truy vấn tham chiếu đến các bí danh đã tạo ở trên]
```

* **Từ khóa `WITH`** chỉ được sử dụng một lần ở đầu.
* Mỗi truy vấn được định nghĩa bên trong mệnh đề `WITH` phải được đặt trong dấu ngoặc đơn và phải có `[alias_name] AS` đứng trước (trong trường hợp này, `AS` là bắt buộc).
* Một truy vấn trong mệnh đề `WITH` có thể tham chiếu đến bất kỳ truy vấn nào được định nghĩa trước đó trong cùng mệnh đề.
* Trong truy vấn `SELECT` cuối cùng, CTE được tham chiếu bằng bí danh của nó (ví dụ: `FROM sales_by_day_vendor AS s`), cho phép bạn lọc, tính toán và thực hiện bất kỳ thao tác nào như với một bảng cơ sở dữ liệu thông thường.

### 4. CTE và Subqueries (Truy vấn con)

CTE thường được ưa chuộng hơn Subqueries lồng nhau vì chúng mang lại sự rõ ràng và khả năng đọc tốt hơn.

Trong một số trường hợp, nếu bạn muốn thực hiện các thao tác trên kết quả của một hàm cửa sổ (window function), bạn cần phải xử lý hàm cửa sổ trên toàn bộ tập dữ liệu trước. Nếu không sử dụng CTE, bạn sẽ phải lồng truy vấn đó vào trong một truy vấn khác (subquery). Tuy nhiên, việc sử dụng CTE cho phép bạn đặt truy vấn phức tạp này vào mệnh đề `WITH`, sau đó truy vấn từ bí danh của nó, giúp cấu trúc truy vấn dễ quản lý hơn nhiều.

### 5. CTE và Views

Cả CTE và Views đều cho phép bạn truy vấn từ kết quả của các tập dữ liệu tùy chỉnh. Sự khác biệt chính là ở khả năng lưu trữ:

* **CTE (Common Table Expression):** Không lưu trữ kết quả. Chúng chỉ tồn tại trong phạm vi của truy vấn mà chúng được định nghĩa.
* **Views (Khung nhìn):** Lưu trữ chính câu lệnh SQL và chạy nó động (dynamically) mỗi khi bạn truy vấn tên của view. View là một đối tượng cơ sở dữ liệu vĩnh viễn hơn, trong khi CTE là một công cụ tạm thời để làm sạch truy vấn.
