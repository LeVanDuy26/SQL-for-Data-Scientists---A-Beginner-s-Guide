### I. Vị trí và Cấu trúc Cú pháp

1.  **Vị trí:** Mệnh đề `HAVING` là một trong những mệnh đề cuối cùng được xử lý trong cấu trúc truy vấn `SELECT`. Nó được đặt **sau mệnh đề `GROUP BY`**.
2.  **Cấu trúc Tổng quát:** Cấu trúc cú pháp cơ bản của truy vấn `SELECT` với `HAVING` là:

    ```sql
    SELECT [columns to return]
    FROM [table]
    WHERE [conditional filter statements]
    GROUP BY [columns to group on]
    HAVING [conditional filter statements that are run after grouping]
    ORDER BY [columns to sort on]
    ```
    Mệnh đề `HAVING` được theo sau bởi các câu lệnh lọc có điều kiện, được chạy **sau khi quá trình nhóm (grouping) diễn ra**.

### II. Mục đích: Lọc Dựa trên Giá trị Tổng hợp (Filtering on Aggregate Values)

Mục đích chính của `HAVING` là cho phép người dùng lọc các nhóm dữ liệu dựa trên kết quả của các **hàm tổng hợp (aggregate functions)** như `SUM()`, `COUNT()`, `AVG()`, `MIN()`, hoặc `MAX()`.

1.  **Sự khác biệt với WHERE:**
    *   **`WHERE`:** Lọc các hàng dữ liệu **riêng lẻ** (row by row) **trước** khi việc nhóm và tổng hợp diễn ra. Mệnh đề `WHERE` không thể tham chiếu đến các hàm tổng hợp.
    *   **`HAVING`:** Lọc các **nhóm** dữ liệu **sau khi** các hàm tổng hợp đã được áp dụng. Điều này cho phép lọc dựa trên các giá trị tổng hợp được tạo ra bởi các hàm như `SUM()` hoặc `COUNT()`.

2.  **Ví dụ Ứng dụng:**
    *   Nếu bạn muốn lọc dữ liệu để chỉ bao gồm các giao dịch mua hàng của **những khách hàng đã chi tiêu tổng cộng trên $50** (giá trị tổng hợp), bạn phải sử dụng `HAVING`.
    *   Ví dụ minh họa trong nguồn tài liệu: Lọc để chỉ trả về các nhà cung cấp (vendors) đã mang **ít nhất 100 mặt hàng** đến chợ nông sản trong khoảng thời gian xác định (dựa trên tổng số lượng hàng tồn kho được tính bằng `SUM(quantity)`).

### III. Ví dụ Minh họa Chi tiết

Trong ví dụ về việc tìm các nhà cung cấp mang ít nhất 100 mặt hàng đến chợ, `WHERE` được sử dụng để lọc theo phạm vi ngày **trước** khi nhóm, và `HAVING` được sử dụng để lọc tổng số lượng hàng tồn kho **sau** khi tính tổng số lượng đó cho mỗi nhà cung cấp:

```sql
SELECT
    vendor_id,
    SUM(quantity) AS inventory_item_count,
    -- Các trường tổng hợp khác
FROM farmers_market.vendor_inventory
WHERE market_date BETWEEN '2019- 03- 02' AND '2019- 03- 16'
GROUP BY vendor_id
HAVING inventory_item_count >= 100
ORDER BY vendor_id
```
Truy vấn này đầu tiên lọc các hàng theo ngày, sau đó nhóm theo `vendor_id`, tính toán `inventory_item_count` (`SUM(quantity)`), và cuối cùng sử dụng `HAVING` để loại bỏ các nhóm (nhà cung cấp) có tổng số lượng mặt hàng dưới 100.

### IV. Sử dụng trong Kiểm tra Chất lượng (Quality Check)

Một ứng dụng hữu ích của mệnh đề `HAVING` trong việc kiểm tra chất lượng dữ liệu hoặc truy vấn là để tìm kiếm các bản ghi bị trùng lặp không mong muốn (unwanted duplicates):

*   Nếu bạn nhóm (`GROUP BY`) tất cả các trường mà lẽ ra phải là duy nhất trong tập dữ liệu kết quả, sau đó thêm mệnh đề `HAVING` để lọc các nhóm có số lượng hàng lớn hơn 1 (`COUNT(*) > 1`), bất kỳ kết quả nào được trả về sẽ chỉ ra sự tồn tại của các bản ghi không duy nhất hoặc trùng lặp trong cơ sở dữ liệu hoặc trong kết quả truy vấn của bạn.

### V. Vị trí Lọc trong Subqueries

Mệnh đề `HAVING` cũng xuất hiện trong bối cảnh các truy vấn con (subqueries) hoặc Biểu thức Bảng Chung (CTE). Ví dụ, trong truy vấn đếm số lần mua hàng của khách hàng trong 31 ngày, `HAVING` được sử dụng để lọc kết quả cuối cùng sau khi đã nhóm và đếm số lần mua hàng duy nhất (`COUNT(DISTINCT market_date) = 1`).

Tóm lại, `HAVING` là công cụ không thể thiếu khi cần thực hiện các phép lọc dựa trên các phép tính tổng hợp, điều này thường xuyên xảy ra khi xây dựng các báo cáo phân tích hoặc tập dữ liệu có mức độ chi tiết đã được tóm tắt (aggregated datasets).