### I. Khái niệm và Vai trò của Self-Join

Tự kết nối xảy ra khi một bảng được kết nối với chính nó. Về mặt kỹ thuật, người ta có thể hình dung nó giống như việc **kết nối hai bản sao** của cùng một bảng.

**Yêu cầu cốt lõi:** Để phân biệt giữa hai "bản sao" của bảng, điều bắt buộc là phải gán **bí danh (alias)** riêng cho mỗi bản sao. Khi viết mã SQL, truy vấn được viết giống như bất kỳ cú pháp `JOIN` nào khác, nhưng tham chiếu đến cùng một tên bảng hai lần.

### II. Cú pháp Cơ bản và Cách Tham Chiếu

Cú pháp cơ bản của self-join liên quan đến việc sử dụng `FROM` và `JOIN` cùng một tên bảng, nhưng với hai bí danh khác nhau:

```sql
SELECT t1.id1, t1.field2, t2.field2, t2.field3
FROM mytable AS t1
LEFT JOIN mytable AS t2
ON t1.id1 = t2.id1
```
Ví dụ cú pháp này chỉ nhằm mục đích minh họa cách sử dụng bí danh (`t1` và `t2`) để tham chiếu cùng một bảng.

### III. Ứng dụng Phân tích Nâng cao (To-Date Maximum)

Self-join trở nên thực sự hữu ích khi người dùng muốn so sánh các hàng trong cùng một bảng với nhau, thường sử dụng một **toán tử so sánh không phải dấu bằng** (comparison operator other than an equal sign).

Một ví dụ thực tế được trình bày là sử dụng self-join để xác định **Giá trị Tối đa Tính đến Thời điểm Hiện tại (To-Date Maximum)**:

1.  **Mục tiêu:** Xây dựng một báo cáo cho thấy liệu tổng doanh số bán hàng trong mỗi ngày chợ có phải là mức cao nhất được thiết lập cho đến ngày đó hay không (tức là so sánh doanh số ngày hiện tại với doanh số tối đa của tất cả các ngày trước đó).
2.  **Chuẩn bị Dữ liệu:** Đầu tiên, tổng hợp doanh số bán hàng theo `market_date` và đặt truy vấn này vào một Biểu thức Bảng Chung (CTE) (ví dụ: `sales_per_market_date`).
3.  **Thực hiện Self-Join:** Thực hiện `LEFT JOIN` CTE này với chính nó, sử dụng các bí danh riêng biệt (ví dụ: `cm` cho "current market date" - ngày chợ hiện tại, và `pm` cho "previous market date" - ngày chợ trước đó):
    *   Thay vì dùng dấu bằng (`=`), truy vấn sử dụng **dấu nhỏ hơn (`<`)** trong mệnh đề `ON` (`ON pm.market_date < cm.market_date`).
    *   Kỹ thuật này nối mỗi hàng (`cm`) với **tất cả các hàng khác** (`pm`) có giá trị `market_date` xảy ra trước ngày chợ hiện tại.
4.  **Tính toán Giá trị Tổng hợp:** Sau khi nối, sử dụng hàm tổng hợp `MAX()` trên dữ liệu của bảng "trước đó" (`pm`) để tìm giá trị doanh số tối đa của các ngày trước đó (`MAX(pm.sales) AS previous_max_sales`).
5.  **Tạo Cột Cờ (Flag Column):** Sử dụng câu lệnh `CASE` để so sánh doanh số của ngày hiện tại (`cm.sales`) với giá trị tối đa trước đó (`MAX(pm.sales)`) để đặt cờ "YES" nếu doanh số hiện tại là một kỷ lục bán hàng mới.

Tác giả cảnh báo rằng loại `JOIN` này rất dễ mắc lỗi, vì vậy cần kiểm tra cẩn thận kết quả để đảm bảo đầu ra mong muốn được tạo ra.

### IV. Self-Join trong Bối cảnh SQL JOINs Rộng hơn

Self-Join là một kỹ thuật linh hoạt hơn các loại JOIN tiêu chuẩn (`INNER JOIN`, `LEFT JOIN`, `RIGHT JOIN`).

*   **Tính linh hoạt:** Trong khi các JOIN tiêu chuẩn kết hợp dữ liệu giữa các thực thể khác nhau, self-join cho phép so sánh các bản ghi trong cùng một thực thể (ví dụ: so sánh doanh số hàng tháng của một thị trường với doanh số kỷ lục của chính thị trường đó).
*   **Sử dụng toán tử so sánh:** Việc sử dụng các toán tử so sánh như **nhỏ hơn (`<`)** hoặc **khác dấu bằng** (`<>`) trong self-join là điển hình cho các tình huống so sánh theo chuỗi thời gian hoặc tìm kiếm mối quan hệ thứ bậc trong dữ liệu.