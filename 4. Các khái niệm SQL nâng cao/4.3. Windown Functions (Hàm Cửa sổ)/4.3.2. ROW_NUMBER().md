`ROW_NUMBER()` là một trong những Hàm Cửa sổ (Window Functions) cơ bản và quan trọng nhất. Trong bối cảnh rộng hơn của Hàm Cửa sổ, chức năng của `ROW_NUMBER()` là **gán một số thứ tự duy nhất** cho mỗi hàng trong một tập hợp các bản ghi, thường được gọi là **phân vùng (Partition)**.

Dưới đây là thảo luận chi tiết về `ROW_NUMBER()` và vai trò của nó trong việc xếp hạng duy nhất:

### I. Khái niệm và Đặc điểm của ROW_NUMBER()

`ROW_NUMBER()` là một hàm xếp hạng (ranking function) không làm thay đổi số lượng hàng được trả về, cho phép người dùng thực hiện các phép tính trên nhiều bản ghi mà không cần nhóm chúng trong kết quả đầu ra. Mục đích của nó là đặt giá trị của một hàng vào ngữ cảnh so sánh với một nhóm hàng mà nó thuộc về.

`ROW_NUMBER()` được sử dụng để:

1.  **Đánh số thứ tự duy nhất:** Chức năng chính là gán một số nguyên tăng dần (ví dụ: 1, 2, 3,...) cho mỗi hàng trong phân vùng mà nó hoạt động.
2.  **Duy trì chi tiết:** Không giống như các hàm tổng hợp thông thường sử dụng `GROUP BY`, `ROW_NUMBER()` cho phép duy trì thông tin chi tiết cấp hàng (row-level information) đồng thời thêm kết quả xếp hạng nhóm vào kết quả.

### II. Cú pháp Xác định Cửa sổ Xếp hạng

Mệnh đề `ROW_NUMBER()` luôn đòi hỏi cú pháp `OVER (PARTITION BY ... ORDER BY ...)` để xác định phạm vi và thứ tự xếp hạng.

#### 1. PARTITION BY (Xác định Partition/Nhóm)

Mệnh đề `PARTITION BY` bên trong `OVER()` định nghĩa các nhóm hoặc **phân vùng** mà hàm `ROW_NUMBER()` sẽ áp dụng.

*   **Cơ chế:** Khi đến một phân vùng mới, số thứ tự `ROW_NUMBER()` sẽ được **đặt lại (reset) về 1**.
*   **Ví dụ:** Để xếp hạng sản phẩm theo giá *cho mỗi nhà cung cấp*, người ta sẽ sử dụng `PARTITION BY vendor_id`. Điều này chia các hàng thành các nhóm theo nhà cung cấp, và việc đánh số hàng sẽ bắt đầu lại khi chuyển sang `vendor_id` tiếp theo.
*   **Không có PARTITION BY:** Nếu `PARTITION BY` bị loại bỏ, hàm sẽ xử lý **toàn bộ tập kết quả** như một phân vùng duy nhất, đánh số thứ tự từ 1 đến hết trên tất cả các hàng.

#### 2. ORDER BY (Xác định Thứ tự Xếp hạng)

Mệnh đề `ORDER BY` bên trong `OVER()` chỉ định tiêu chí sắp xếp các hàng *trong mỗi partition* trước khi chúng được đánh số.

*   **Mục đích:** `ORDER BY original_price DESC` sẽ đảm bảo rằng sản phẩm có giá cao nhất trong mỗi partition nhận được số thứ tự thấp nhất, tức là **`price_rank` là 1**.

### III. ROW_NUMBER() và Khả năng Xếp hạng Duy nhất

Khác biệt chính của `ROW_NUMBER()` so với `RANK()` và `DENSE_RANK()` là tính chất **duy nhất** của số thứ tự:

*   `ROW_NUMBER()` sẽ gán một số nguyên riêng biệt cho mỗi hàng, **ngay cả khi các hàng đó có cùng giá trị** (tie).
*   Ngược lại, `RANK()` và `DENSE_RANK()` cho phép các hàng trùng lặp về giá trị nhận cùng một thứ hạng.
*   **Xử lý Tie:** Nếu có nhiều mục có cùng giá trị (ví dụ: hai sản phẩm có cùng giá cao nhất), `ROW_NUMBER()` sẽ tùy ý gán thứ hạng 1 và 2 cho chúng. Để kiểm soát thứ tự này, người dùng có thể thêm các cột sắp xếp bổ sung vào mệnh đề `ORDER BY` (ví dụ: sắp xếp theo giá giảm dần và sau đó là ngày thị trường tăng dần).

### IV. Ứng dụng Nâng cao: Tìm Bản ghi Hàng đầu (Top Records)

Ứng dụng phổ biến nhất của `ROW_NUMBER()` là tìm bản ghi có giá trị cao nhất hoặc thấp nhất (ví dụ: sản phẩm đắt nhất) trong mỗi partition.

#### 1. Sử dụng Truy vấn Con (Subqueries)

Do Hàm Cửa sổ, bao gồm `ROW_NUMBER()`, được tính toán trên toàn bộ tập dữ liệu hoặc phân vùng **trước** khi các mệnh đề lọc (`WHERE`) được áp dụng, không thể lọc trực tiếp bằng biệt danh (alias) của cột xếp hạng trong truy vấn gốc.

Để giải quyết vấn đề này, người ta phải **lồng truy vấn chứa `ROW_NUMBER()` bên trong một Truy vấn Con** (Subquery).

*   **Cơ chế:** Truy vấn bên trong (`inner query`) tính toán cột xếp hạng (ví dụ: `price_rank`). Truy vấn bên ngoài (`outer query`) sau đó xử lý kết quả này (đã được đặt biệt danh là một bảng, ví dụ: `x`) và sử dụng mệnh đề `WHERE` để lọc chỉ những hàng có `price_rank = 1`.
*   **Ví dụ:** Để chỉ trả về sản phẩm có giá cao nhất (`price_rank = 1`) cho mỗi nhà cung cấp, truy vấn bên ngoài sẽ lọc `WHERE x.price_rank = 1`.

Nếu không sử dụng truy vấn con, việc cố gắng lọc bằng giá trị `price_rank` trong mệnh đề `WHERE` của truy vấn gốc sẽ dẫn đến lỗi, vì giá trị đó chưa được tính toán xong.

### V. Các Hàm Cửa sổ Tương tự

Mặc dù `ROW_NUMBER()` đảm bảo tính duy nhất, hai hàm xếp hạng khác có cùng cú pháp `OVER (PARTITION BY ... ORDER BY ...)` là:

*   **`RANK()`:** Xếp hạng các hàng, cho phép các hàng trùng lặp về giá trị nhận cùng một thứ hạng, nhưng **bỏ qua** các số hạng tiếp theo (ví dụ: 1, 1, 3, bỏ qua 2).
*   **`DENSE_RANK()`:** Xếp hạng các hàng, cho phép các hàng trùng lặp về giá trị nhận cùng một thứ hạng, nhưng **không bỏ qua** các số hạng tiếp theo (ví dụ: 1, 1, 2).