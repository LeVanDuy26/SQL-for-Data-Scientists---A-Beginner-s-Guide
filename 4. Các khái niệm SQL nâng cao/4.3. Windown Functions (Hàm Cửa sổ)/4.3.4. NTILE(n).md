### I. Khái niệm và Mục đích của NTILE(n)

`NTILE(n)` là một Hàm Cửa sổ cho phép các nhà khoa học dữ liệu **chia tập kết quả (hoặc một phân vùng)** thành $n$ khối (blocks) hoặc nhóm (groups) có kích thước bằng nhau.

#### 1. Cú pháp và Tham số
Cú pháp của `NTILE` bao gồm việc chỉ định số lượng nhóm (`n`) bên trong dấu ngoặc đơn: `NTILE(n)`.
*   **Ví dụ:** `NTILE(10)` sẽ chia kết quả thành 10 nhóm đều nhau, đại diện cho top 1/10, 2/10, v.v., của dữ liệu.

#### 2. Mục đích Sử dụng
Mục đích chính của `NTILE` là giải quyết các câu hỏi yêu cầu phân tích dữ liệu dựa trên các phân đoạn có kích thước đều nhau, ví dụ: "Làm thế nào để trả về **top 1/10** (top tenth) hàng tồn kho khi sắp xếp theo giá?".

Nếu không có `NTILE`, để đạt được kết quả tương tự, người dùng sẽ phải thực hiện các bước thủ công: chạy một truy vấn để **`COUNT()`** tổng số hàng, chia số đó cho $n$ (ví dụ: 10), và sau đó viết một truy vấn khác sử dụng Hàm Cửa sổ `ROW_NUMBER()` và lọc kết quả dựa trên số lượng hàng đã tính toán. `NTILE` cung cấp một giải pháp **động (dynamic solution)** cho vấn đề này, tự động điều chỉnh khi số lượng hàng trong cơ sở dữ liệu thay đổi.

### II. Cú pháp Xác định Cửa sổ

Giống như các Hàm Cửa sổ khác (`ROW_NUMBER()`, `RANK()`, `DENSE_RANK()`), `NTILE()` yêu cầu mệnh đề `OVER()` để xác định tập hợp các hàng mà hàm sẽ hoạt động.

#### 1. ORDER BY (Bắt buộc)
Mệnh đề **`ORDER BY`** bên trong `OVER()` là **bắt buộc** và xác định thứ tự mà các hàng sẽ được chia thành các nhóm.
*   **Ví dụ:** Để chia tập dữ liệu thành 10 nhóm dựa trên giá giảm dần, cú pháp sẽ là: `NTILE(10) OVER (ORDER BY original_price DESC)`.

#### 2. PARTITION BY (Tùy chọn)
`NTILE` có thể bao gồm mệnh đề `PARTITION BY`.
*   Nếu không có `PARTITION BY`, hàm sẽ phân đoạn **toàn bộ tập kết quả** thành $n$ nhóm.
*   Nếu có `PARTITION BY`, `NTILE` sẽ phân đoạn từng nhóm (partition) thành $n$ nhóm nhỏ hơn.

### III. Cơ chế Phân chia Nhóm

Cơ chế phân chia nhóm của `NTILE(n)` được xác định bởi số lượng hàng trong tập kết quả:

1.  **Phân chia Đồng đều:** Nếu tổng số hàng có thể được chia hết cho $n$, kết quả sẽ được chia thành $n$ nhóm có **kích thước bằng nhau**.
2.  **Phân chia Không đều:** Nếu tổng số hàng không chia hết cho $n$, **một số nhóm sẽ có thêm một hàng** so với các nhóm khác để đảm bảo tính phân phối đều nhất có thể.

### IV. Thận trọng khi Sử dụng NTILE

Tài liệu nhấn mạnh một lưu ý quan trọng về cách `NTILE` xử lý dữ liệu:

*   **Dựa trên Đếm Hàng (Row Count):** `NTILE` chỉ sử dụng **số lượng hàng** để phân chia các nhóm; nó không xem xét các giá trị thực tế của cột sắp xếp.
*   **Vấn đề Giá trị Trùng lặp (Ties):** Do dựa trên số lượng hàng, có khả năng hai hàng có **cùng giá trị** (ví dụ: hai sản phẩm có cùng `original_price`) có thể bị chia vào **hai nhóm `NTILE` khác nhau** nếu ranh giới phân đoạn rơi vào giữa các hàng có giá trị trùng lặp đó.
*   **Khuyến nghị:** Nếu mục tiêu là đảm bảo tất cả các mục có cùng giá trị phải được nhóm lại với nhau (ví dụ: tất cả các sản phẩm giá $4.00 phải nằm trong cùng một nhóm giá thấp), thì nên sử dụng Hàm xếp hạng **`RANK()`** thay vì `NTILE`.

### V. Ứng dụng Nâng cao: So sánh Giá

Trong một ví dụ nâng cao (Chương 13), `NTILE` được sử dụng để phân tích sự phân phối giá sản phẩm:

*   **Chia thành 3 nhóm (Terciles):** Tác giả đã sử dụng `NTILE(3)` để chia giá sản phẩm (đã được nhóm theo năm và mùa) thành ba nhóm: nhóm giá thấp nhất (NTILE 1), nhóm giá giữa (NTILE 2) và nhóm giá cao nhất (NTILE 3).
*   **Tạo Thứ hạng Kép:** Tác giả đã tạo hai cột NTILE: một cột sắp xếp giá tăng dần (`price_ntile`) và một cột sắp xếp giá giảm dần (`price_ntile_desc`). Điều này cho phép người dùng dễ dàng lọc ra nhóm giá thấp nhất (`price_ntile = 1`) và nhóm giá cao nhất (`price_ntile_desc = 1`) mà không cần biết tổng số nhóm là bao nhiêu.
*   **Tính linh hoạt theo Nhóm:** Việc sử dụng `PARTITION BY market_year, market_season` đảm bảo rằng việc phân chia giá thành ba nhóm là **riêng biệt cho mỗi mùa và mỗi năm**, cho thấy các ngưỡng giá thay đổi theo thời gian. Ví dụ, một mặt hàng có giá $4.00 có thể là nhóm giữa (NTILE 2) vào mùa hè nhưng lại rơi vào nhóm giá thấp (NTILE 1) vào mùa xuân, do sự thay đổi về sự phân phối giá sản phẩm có sẵn trong mùa đó.