Hàm Cửa sổ là một trong những công cụ mạnh mẽ nhất trong SQL nâng cao mà các nhà khoa học dữ liệu sử dụng để đặt giá trị của một hàng (row) vào ngữ cảnh so sánh với một nhóm hàng (partition) mà nó thuộc về.

### I. Khái niệm và Mục đích của Cửa sổ (Window/Partition)

Mệnh đề **`OVER`** là cú pháp bắt buộc đi kèm với mọi Hàm Cửa sổ (như `ROW_NUMBER()`, `RANK()`, `SUM()` được sử dụng như hàm cửa sổ). Mệnh đề `OVER` này có trách nhiệm **xác định tập hợp các hàng** (tức là "cửa sổ" hoặc "phân vùng") mà hàm cửa sổ sẽ hoạt động trên đó.

Kết quả của Hàm Cửa sổ là các phép tính tổng hợp hoặc xếp hạng được trả về **bên cạnh thông tin chi tiết cấp hàng riêng lẻ (individual row-level information)** cho các mục trong nhóm đó.

### II. Vai trò của PARTITION BY trong việc Định nghĩa Cửa sổ

**`PARTITION BY`** có chức năng tương tự như mệnh đề `GROUP BY` nhưng có một khác biệt then chốt:

1.  **Chức năng:** `PARTITION BY` chỉ định cách chia các hàng thành các nhóm hoặc **phân vùng (partitions)**. Hàm Cửa sổ sẽ tính toán lại từ đầu cho mỗi phân vùng này.
2.  **Khác biệt so với `GROUP BY`:** Khi sử dụng `PARTITION BY`, các hàng **không bị tổng hợp lại thành một hàng duy nhất** trong kết quả đầu ra. Điều này cho phép duy trì mức độ chi tiết của dữ liệu (detail-level information) mà người dùng sẽ bị mất nếu sử dụng `GROUP BY` thông thường.

*   **Ví dụ minh họa:** Trong truy vấn xếp hạng sản phẩm theo giá của mỗi nhà cung cấp, mệnh đề `PARTITION BY vendor_id` chỉ định rằng việc đánh số hàng và xếp hạng phải bắt đầu lại khi chuyển sang một `vendor_id` mới. Điều này được hiểu là "chia các hàng thành các nhóm theo nhà cung cấp, mà không cần tổng hợp chúng".

### III. Vai trò của ORDER BY trong Cửa sổ

Mệnh đề **`ORDER BY`** bên trong `OVER()` chỉ định cách các hàng trong mỗi phân vùng (hoặc toàn bộ tập kết quả nếu không có `PARTITION BY`) nên được sắp xếp.

1.  **Chức năng:** `ORDER BY` xác định thứ tự mà các hàm cửa sổ (đặc biệt là các hàm xếp hạng như `ROW_NUMBER()` hoặc các hàm dịch chuyển như `LAG()`/`LEAD()`) sẽ hoạt động.
2.  **Ứng dụng xếp hạng:** Khi tìm sản phẩm đắt nhất của mỗi nhà cung cấp, việc sử dụng `ORDER BY original_price DESC` bên trong `OVER()` đảm bảo rằng sản phẩm có giá cao nhất sẽ được gán số hàng thấp nhất (ví dụ: `price_rank = 1`).
3.  **Ứng dụng Tổng chạy (Running Totals):** Khi sử dụng Hàm Tổng hợp (như `SUM()`) làm Hàm Cửa sổ, việc thêm `ORDER BY` sẽ biến phép tính đó thành **tổng tích lũy hoặc tổng chạy** (running total). Nếu không có `ORDER BY` bên trong `OVER()`, hàm `SUM()` sẽ tính tổng toàn bộ phân vùng (hoặc toàn bộ tập kết quả) và hiển thị giá trị tổng đó trên **mọi hàng** trong phân vùng.

### IV. Các trường hợp sử dụng cú pháp OVER

Cú pháp `OVER` có thể được sử dụng trong nhiều trường hợp khác nhau:

1.  **Chỉ có ORDER BY, không có PARTITION BY:** Hàm Cửa sổ sẽ tính toán trên **toàn bộ tập kết quả** (xem như một cửa sổ lớn), nhưng tuân theo thứ tự đã sắp xếp. Ví dụ, `SUM(...) OVER (ORDER BY market_date)` sẽ tính **tổng chạy** (running total) trên toàn bộ tập dữ liệu, dựa trên thứ tự ngày tháng.
2.  **Chỉ có PARTITION BY, không có ORDER BY:** Hàm Cửa sổ sẽ tính toán giá trị tổng hợp (chẳng hạn như `SUM()`, `AVG()`) cho mỗi phân vùng và **hiển thị giá trị tổng đó trên mọi hàng** trong phân vùng đó. Ví dụ: `SUM(...) OVER (PARTITION BY customer_id)` sẽ tính tổng chi tiêu của khách hàng và hiển thị tổng đó trên từng giao dịch mua hàng của họ.
3.  **Cả hai (PARTITION BY và ORDER BY):** Đây là trường hợp phổ biến nhất cho các hàm xếp hạng và tổng chạy theo nhóm. Ví dụ: `ROW_NUMBER() OVER (PARTITION BY vendor_id ORDER BY original_price DESC)` xếp hạng giá sản phẩm cao nhất theo từng nhà cung cấp.

### V. Sự cần thiết của Truy vấn Con (Subqueries)

Vì Hàm Cửa sổ (`ROW_NUMBER()`, `RANK()`, `NTILE()`, v.v.) được tính toán trên toàn bộ tập dữ liệu hoặc phân vùng **trước** khi các mệnh đề lọc như `WHERE` được áp dụng, người dùng thường phải **lồng truy vấn chứa hàm cửa sổ bên trong một Truy vấn Con (Subquery)**.

*   **Lý do:** Điều này cho phép truy vấn bên ngoài (`outer query`) xử lý kết quả đã được tính toán của Hàm Cửa sổ. Ví dụ: sau khi tính `price_rank` trong truy vấn con, truy vấn ngoài có thể sử dụng mệnh đề `WHERE` để lọc chỉ những hàng có `price_rank = 1`. Nếu cố gắng sử dụng giá trị `price_rank` trong mệnh đề `WHERE` của truy vấn gốc, SQL sẽ báo lỗi vì giá trị đó chưa được tính toán xong.

Tóm lại, cú pháp **`OVER (PARTITION BY ... ORDER BY ...)`** là cấu trúc ngữ pháp định nghĩa phạm vi tính toán cho Hàm Cửa sổ, cho phép các nhà khoa học dữ liệu thực hiện các phép tính phức tạp như xếp hạng, tổng chạy và so sánh giá trị giữa các hàng trong ngữ cảnh nhóm mà không làm mất đi mức độ chi tiết của dữ liệu.