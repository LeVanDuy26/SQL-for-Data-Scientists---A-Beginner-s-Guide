### I. Cơ chế Trả về Giá trị Tổng hợp cho mỗi Hàng

Điểm khác biệt cốt lõi của Hàm Tổng hợp được sử dụng như Window là cách chúng hiển thị kết quả:

1.  **Duy trì chi tiết cấp hàng:** Hàm Cửa sổ cho phép thực hiện các phép tính tổng hợp trên một nhóm các bản ghi (partition) nhưng **không làm nhóm các bản ghi đó lại thành một hàng duy nhất**. Thay vào đó, chúng trả về phép tính tổng hợp nhóm bên cạnh thông tin cấp hàng riêng lẻ cho các mục trong nhóm đó.
2.  **Mục đích:** Cách tiếp cận này cho phép người dùng so sánh giá trị của từng hàng (row) với giá trị tổng hợp cho nhóm (partition) mà nó thuộc về.

### II. Cú pháp và Cách xác định "Cửa sổ" (Window)

Để sử dụng một hàm tổng hợp như một hàm cửa sổ, người ta phải thêm mệnh đề `OVER()` vào sau hàm đó. Mệnh đề `OVER()` xác định tập hợp các hàng ("cửa sổ") mà phép tính sẽ hoạt động trên đó.

*   **`AVG(original_price) OVER (PARTITION BY market_date ...)`**.

### III. Các Ứng dụng của Hàm Tổng hợp Window

Tùy thuộc vào việc người dùng sử dụng `PARTITION BY` và `ORDER BY` như thế nào trong mệnh đề `OVER()`, kết quả của hàm tổng hợp sẽ thay đổi:

#### 1. Tính Tổng Hợp Toàn Bộ Phân Vùng (Partition Aggregate Total)

Nếu hàm tổng hợp được sử dụng với **`PARTITION BY` nhưng không có `ORDER BY`** bên trong `OVER()`:

*   Hàm sẽ tính toán tổng giá trị tổng hợp (ví dụ: tổng chi tiêu) cho toàn bộ phân vùng.
*   Nó sẽ **hiển thị giá trị tổng hợp đó trên mỗi hàng** trong phân vùng.
*   **Ví dụ:** Sử dụng `SUM(...) OVER (PARTITION BY customer_id)` sẽ tính tổng chi tiêu của khách hàng đó và hiển thị tổng số tiền đó trên từng giao dịch mua hàng của họ.

#### 2. Tính Tổng Chạy (Running Totals)

Nếu hàm tổng hợp được sử dụng với **`ORDER BY`** (có hoặc không có `PARTITION BY`):

*   Hàm `SUM()` sẽ hoạt động như một **tổng tích lũy** hoặc **tổng chạy**.
*   Phép tính được thực hiện theo thứ tự được chỉ định trong `ORDER BY`, cộng dồn giá trị qua từng hàng.
*   **Có `PARTITION BY`:** Tổng chạy sẽ được tính riêng biệt cho từng phân vùng và sẽ **đặt lại về 0** (hoặc bắt đầu lại) khi chuyển sang phân vùng mới (ví dụ: tính tổng chi tiêu tích lũy của từng khách hàng, tổng sẽ reset khi chuyển sang khách hàng khác).
*   **Không có `PARTITION BY`:** Tổng chạy sẽ được tính trên toàn bộ tập kết quả.

#### 3. So sánh Giá trị Cấp Hàng với Giá trị Cấp Nhóm (`AVG`, `COUNT`)

Hàm tổng hợp dạng Window rất hữu ích để thêm ngữ cảnh cho dữ liệu chi tiết:

*   **Hàm `AVG()`:** Cho phép so sánh giá trị của từng hàng với giá trị trung bình của nhóm. Ví dụ, tính giá trị trung bình của sản phẩm trên mỗi ngày thị trường (`market_date`) và hiển thị giá trị trung bình này trên mỗi hàng sản phẩm, giúp xác định sản phẩm nào có giá cao hơn mức trung bình của thị trường ngày hôm đó.
*   **Hàm `COUNT()`:** Có thể được sử dụng để đếm số lượng mục trong mỗi phân vùng (ví dụ: đếm số lượng sản phẩm mỗi nhà cung cấp mang đến thị trường trong một ngày) và hiển thị số đếm đó trên mỗi hàng chi tiết của sản phẩm đó.

### IV. Vị trí trong Cấu trúc Truy vấn (Subqueries)

Vì Hàm Tổng hợp Window được tính toán trên toàn bộ tập dữ liệu (hoặc phân vùng) **trước** khi các mệnh đề lọc (`WHERE`) được áp dụng, nếu người dùng muốn lọc kết quả dựa trên giá trị tổng hợp đã tính toán (ví dụ: chỉ trả về các sản phẩm có giá cao hơn mức giá trung bình của thị trường), họ phải:

*   **Bọc truy vấn chứa hàm cửa sổ bên trong một Truy vấn Con (Subquery)**.
*   Truy vấn ngoài sau đó có thể tham chiếu đến cột đã được tính toán bởi hàm cửa sổ để lọc hoặc thực hiện các phép tính khác.