### I. Khái niệm và Mục đích của CASE Statements

CASE Statements là cơ chế trong SQL cho phép thực hiện **logic điều kiện** tương tự như câu lệnh "if" trong các ngôn ngữ lập trình khác, nhưng với cú pháp đặc thù của SQL.

*   **Mục đích cốt lõi:** Thay vì lọc các hàng (như mệnh đề `WHERE` - đã được thảo luận trong Chương 3), CASE Statements được sử dụng để **tạo ra các cột dữ liệu mới (derived columns)** hoặc **thay đổi giá trị** trong một cột dựa trên một tập hợp các điều kiện.
*   **Vai trò trong Khoa học Dữ liệu:** Đây là một công cụ thiết yếu để **Kỹ thuật Tính năng (Feature Engineering)**, tức là tạo ra các cột mới để trình bày dữ liệu theo cách khác biệt, thường là chuyển đổi các thuộc tính thành định dạng số hóa mà các thuật toán học máy có thể sử dụng.

### II. Cú pháp Chính: `CASE WHEN...THEN...ELSE END`

Cú pháp của CASE Statements tuân theo một mô hình logic, diễn tả ý định "Nếu [một điều kiện] là đúng, thì [thực hiện hành động này/trả về giá trị này]. Ngược lại, [thực hiện hành động khác]".

Cấu trúc cơ bản của nó như sau:

```sql
CASE
    WHEN [first conditional statement]
      THEN [value or calculation]
    WHEN [second conditional statement]
      THEN [value or calculation]
    ELSE [value or calculation]
END
```

#### 1. Các Mệnh đề Bắt buộc và Tùy chọn

*   **`CASE` và `END`:** Đây là hai từ khóa bắt buộc đánh dấu sự bắt đầu và kết thúc của khối logic điều kiện.
*   **`WHEN` và `THEN`:** Cặp từ khóa này định nghĩa logic: **`WHEN`** chứa câu lệnh điều kiện (ví dụ: `weather_forecast = 'rain'`), và **`THEN`** chứa giá trị hoặc phép tính sẽ được trả về nếu điều kiện đó là `TRUE`.
*   **`ELSE`:** Mệnh đề này là **tùy chọn**.
    *   Giá trị hoặc kết quả tính toán trong `ELSE` sẽ được trả về nếu **không có bất kỳ điều kiện `WHEN` nào phía trên đánh giá là `TRUE`**.
    *   Nếu mệnh đề `ELSE` bị bỏ qua và không có điều kiện `WHEN` nào đúng, giá trị trả về cho hàng đó sẽ là **`NULL`**.

#### 2. Thứ tự Đánh giá (Evaluation Order)

*   Các mệnh đề `WHEN` được đánh giá theo **thứ tự từ trên xuống dưới**.
*   **Nguyên tắc "First Match":** Ngay khi điều kiện `WHEN` đầu tiên đánh giá là **`TRUE`**, phần `THEN` tương ứng sẽ được thực thi, và **không có bất kỳ điều kiện `WHEN` nào khác (kể cả các điều kiện đúng sau đó) được đánh giá**.
*   **Ví dụ về Ưu tiên:** Truy vấn sau luôn trả về "Yes" vì `1=1` là `TRUE` ngay lập tức, và `2=2` (cũng là `TRUE`) sẽ bị bỏ qua:
    ```sql
    SELECT CASE WHEN 1=1 THEN 'Yes' WHEN 2=2 THEN 'No' END
    ```

### III. Ứng dụng Thực tiễn trong Cú pháp Nâng cao

Cú pháp `CASE WHEN...THEN...ELSE END` có nhiều ứng dụng quan trọng trong việc chuẩn bị dữ liệu:

#### 1. Tạo Biệt danh (Aliasing)

Các cột được tạo ra bằng CASE Statements **nên luôn luôn được đặt biệt danh (alias)**. Điều này đảm bảo tiêu đề cột kết quả dễ đọc và có ý nghĩa (ví dụ: `AS weekend_flag`).

#### 2. Tạo Cờ Nhị phân (Binary Flags)

Cú pháp này thường được sử dụng để tạo ra các trường cờ nhị phân (binary flag field) trả về **1 hoặc 0** để chỉ ra sự tồn tại của một thuộc tính nào đó.

*   **Ví dụ:** Chuyển đổi tên ngày (`Saturday`, `Sunday`) thành một cờ `weekend_flag` (`1` hoặc `0`), giúp các thuật toán học máy sử dụng giá trị số làm đầu vào.

#### 3. Phân loại Giá trị (Grouping or Binning)

Cú pháp `CASE WHEN` cho phép chia một biến liên tục (ví dụ: giá cả) thành các nhóm hoặc phạm vi rời rạc.

*   **Ví dụ:** Phân loại giá mua hàng thành các nhóm chuỗi như 'Under $5', '$5-$9.99', v.v.. Hoặc trả về giá trị số đại diện cho cận dưới của nhóm (ví dụ: 0, 5, 10) nếu yêu cầu đầu ra là số.

#### 4. Mã hóa Phân loại (Categorical Encoding)

Đối với các biến chuỗi phân loại, CASE Statements được dùng để chuyển đổi chúng thành giá trị số:

*   **Mã hóa theo Thứ hạng:** Gán giá trị số theo thứ tự cho các danh mục có thứ hạng (ví dụ: 'A' thành 1, 'B' thành 2).
*   **Mã hóa Một-Nóng (One-Hot Encoding):** Tạo ra một cột mới cho mỗi danh mục, gán **1** nếu hàng thuộc danh mục đó và **0** nếu không, bằng cách lồng nhiều CASE Statements.

#### 5. Kết hợp với Hàm Tổng hợp

Cú pháp `CASE WHEN...THEN...ELSE END` có thể được lồng vào bên trong các hàm tổng hợp như `SUM()` hoặc `COUNT()` (Chương 6). Điều này cho phép người dùng **lựa chọn các giá trị** để tính toán tổng hợp dựa trên điều kiện.

*   **Ví dụ nâng cao:** Sử dụng `SUM(CASE WHEN product_qty_type = "unit" THEN quantity ELSE 0 END)` để chỉ tính tổng số lượng sản phẩm bán theo đơn vị "unit", bỏ qua các sản phẩm bán theo khối lượng "lbs".

Tóm lại, cú pháp `CASE WHEN...THEN...ELSE END` là nền tảng cho việc thao tác logic và chuyển đổi dữ liệu trong SQL. Việc nắm vững cách các mệnh đề được đánh giá theo thứ tự và cách sử dụng các toán tử logic trong `WHEN` là chìa khóa để xây dựng các tập dữ liệu phân tích phức tạp và chính xác.