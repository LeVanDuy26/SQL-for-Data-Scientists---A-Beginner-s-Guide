### I. Khái niệm và Mục đích

Khi tổng hợp dữ liệu giao dịch của khách hàng, việc tìm ra ngày mua hàng đầu tiên và cuối cùng là các số liệu quan trọng để đo lường **thời gian khách hàng (customer duration)** hoặc xác định trạng thái của khách hàng (ví dụ: khách hàng mới hay khách hàng quay lại).

Các hàm `MIN()` và `MAX()` được sử dụng cho mục đích này vì chúng không chỉ hoạt động trên các giá trị số mà còn hoạt động trên các giá trị ngày tháng (`date` hoặc `datetime`).

*   **`MIN(market_date)`:** Khi áp dụng cho cột ngày tháng, hàm này trả về giá trị ngày sớm nhất trong nhóm, tức là **ngày mua hàng đầu tiên (first purchase)** của khách hàng.
*   **`MAX(market_date)`:** Khi áp dụng cho cột ngày tháng, hàm này trả về giá trị ngày muộn nhất trong nhóm, tức là **ngày mua hàng cuối cùng (last purchase)** của khách hàng.

### II. Cú pháp và Thực hiện Tổng hợp

Để sử dụng `MIN()` và `MAX()` để tính toán ngày mua hàng đầu tiên/cuối cùng, cần phải nhóm dữ liệu ở cấp độ khách hàng (customer level) bằng mệnh đề `GROUP BY`.

**Ví dụ Truy vấn Cơ bản:**
Truy vấn này nhóm theo `customer_id` và sử dụng `MIN()`/`MAX()` trên cột `market_date` để tóm tắt lịch sử mua hàng của từng khách hàng:

```sql
SELECT
    customer_id,
    MIN(market_date) AS first_purchase,
    MAX(market_date) AS last_purchase,
    COUNT(DISTINCT market_date) AS count_of_purchase_dates
FROM farmers_market.customer_purchases
GROUP BY customer_id
```
Kết quả của truy vấn này cung cấp một hàng tóm tắt cho mỗi khách hàng, hiển thị ngày mua hàng đầu tiên và cuối cùng của họ.

### III. Ứng dụng Nâng cao: Tính Khoảng thời gian

Các hàm tổng hợp ngày tháng (`MIN`/`MAX`) thường được sử dụng làm tham số đầu vào cho các hàm Ngày và Thời gian khác để tính toán khoảng thời gian, tạo ra các tính năng phân tích mạnh mẽ:

#### 1. Tính Khoảng thời gian giữa lần mua đầu và cuối

Sự khác biệt giữa ngày mua hàng cuối cùng (`MAX(market_date)`) và ngày mua hàng đầu tiên (`MIN(market_date)`) được tính bằng hàm **`DATEDIFF()`**. Điều này giúp xác định **thời gian khách hàng** (customer duration) hay số ngày giữa lần mua hàng đầu tiên và lần mua hàng cuối cùng:

```sql
DATEDIFF(MAX(market_date), MIN(market_date)) AS days_between_first_last_purchase
```
Tài liệu lưu ý rằng kết quả của các hàm tổng hợp (`MIN`, `MAX`) vẫn là các giá trị ngày hợp lệ và do đó có thể được truyền trực tiếp làm tham số cho hàm `DATEDIFF()`.

#### 2. Tính Khoảng thời gian kể từ lần mua cuối

Để xác định số ngày kể từ lần mua cuối cùng của khách hàng đến ngày hiện tại, hàm `MAX(market_date)` được kết hợp với hàm **`CURDATE()`** (hoặc hàm tương đương như `CURRENT_DATE`, `TODAY()`, v.v.).

```sql
DATEDIFF(CURDATE(), MAX(market_date)) AS days_since_last_purchase
```
Đây là một số liệu động, thay đổi mỗi ngày, và rất quan trọng cho các báo cáo theo thời gian thực hoặc trong các mô hình học máy để đo lường mức độ "gần đây" của một khách hàng.

### IV. Sự khác biệt so với Hàm Cửa sổ

Mặc dù `MIN()` và `MAX()` có thể được sử dụng làm Hàm Cửa sổ (Window Functions) (Chương 7), việc sử dụng chúng trong ngữ cảnh **Tổng hợp (Aggregation)** với `GROUP BY` là khác biệt:

*   **Với `GROUP BY`:** Kết quả là một **hàng tóm tắt duy nhất** cho mỗi nhóm khách hàng, trong đó chỉ hiển thị ngày đầu tiên và cuối cùng.
*   **Với Hàm Cửa sổ (Window Functions):** Nếu `MIN(market_date) OVER (PARTITION BY customer_id)` được sử dụng, ngày mua hàng đầu tiên sẽ được tính toán và **hiển thị trên *mỗi hàng* chi tiết** giao dịch mua hàng của khách hàng đó. Điều này cho phép so sánh ngày của giao dịch cụ thể với ngày mua hàng đầu tiên của họ (ví dụ: để tính thời gian kể từ lần mua đầu tiên).