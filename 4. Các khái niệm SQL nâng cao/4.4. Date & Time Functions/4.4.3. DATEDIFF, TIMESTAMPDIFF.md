### I. Hàm DATEDIFF(): Tính toán sự khác biệt theo Ngày

Hàm `DATEDIFF()` là hàm SQL có sẵn trong hầu hết các hệ thống cơ sở dữ liệu và được sử dụng để tính toán sự khác biệt giữa hai ngày hoặc giá trị datetime, và trả về kết quả dưới dạng **số ngày**.

#### 1. Cú pháp và Tham số
Hàm `DATEDIFF()` chấp nhận hai tham số là hai giá trị ngày hoặc datetime.

#### 2. Ứng dụng và Ví dụ
`DATEDIFF()` rất hữu ích khi cần xác định khoảng thời gian giữa các sự kiện dưới dạng số ngày.

*   **Tính Khoảng thời gian giữa các Giao dịch:** Hàm này có thể được sử dụng để tính toán số ngày giữa lần mua hàng đầu tiên và lần mua hàng cuối cùng của một khách hàng.
*   **Tính Khoảng thời gian động:** `DATEDIFF()` được dùng để tính số ngày kể từ lần mua hàng cuối cùng đến ngày hiện tại, thường sử dụng kết hợp với hàm `CURDATE()` (hoặc các hàm tương đương như `CURRENT_DATE`, `TODAY()`, `SYSDATE`, `GETDATE()` tùy hệ thống) để tính toán dựa trên thời gian hệ thống.
*   **Ứng dụng Lọc (Filtering):** `DATEDIFF()` được dùng để lọc dữ liệu trong một phạm vi ngày động (dynamic date range). Ví dụ, để tìm kiếm các giao dịch bán hàng xảy ra trong vòng 31 ngày gần nhất, người ta có thể sử dụng `DATEDIFF('2019- 03- 31', market_date) <= 31`.
*   **Kết hợp với Hàm Tổng hợp/Cửa sổ:** `DATEDIFF()` có thể hoạt động trên kết quả của các hàm tổng hợp như `MIN()` và `MAX()` (vì chúng vẫn trả về giá trị ngày hợp lệ), ví dụ: `DATEDIFF(MAX(market_date), MIN(market_date))`.
*   **Kết hợp với Hàm Cửa sổ (Window Functions):** `DATEDIFF()` thường được sử dụng cùng với hàm `LEAD()` để tính toán số ngày giữa lần mua hàng hiện tại và lần mua hàng tiếp theo (`days_between_purchases`).

### II. Hàm TIMESTAMPDIFF(): Tính toán sự khác biệt theo Đơn vị Khác

Trong MySQL (phiên bản được sử dụng trong tài liệu), `TIMESTAMPDIFF()` là một hàm bổ sung cho phép tính toán sự khác biệt giữa hai giá trị datetime trong **bất kỳ khoảng thời gian nào** được chọn (interval).

#### 1. Cú pháp và Tham số
`TIMESTAMPDIFF()` yêu cầu ba tham số: khoảng thời gian mong muốn (ví dụ: `HOUR`, `MINUTE`), giá trị datetime bắt đầu, và giá trị datetime kết thúc.

#### 2. Ứng dụng và Khả năng Tương thích

*   **Tính khoảng thời gian chi tiết:** Hàm này có thể tính toán số giờ hoặc số phút giữa thời gian bắt đầu và kết thúc thị trường (`market_start_datetime`, `market_end_datetime`).
*   **Khả năng Tương thích (Compatibility):** Cần lưu ý rằng `TIMESTAMPDIFF()` **không tồn tại** trong các hệ thống cơ sở dữ liệu khác như Redshift và MS SQL Server. Trong các hệ thống đó, hàm `DATEDIFF()` đã cho phép chỉ định khoảng thời gian (datepart interval) như một tham số, khiến `TIMESTAMPDIFF()` không cần thiết.

### III. Ứng dụng trong Kỹ thuật Tính năng (Feature Engineering)

Các hàm khác biệt ngày tháng là công cụ quan trọng để tạo ra **biến mục tiêu (target variable)** và **tính năng (feature)** ràng buộc thời gian.

*   **Tạo Biến Mục tiêu:** `DATEDIFF()` được sử dụng để tạo ra cờ nhị phân (`purchased_again_within_30_days`) bằng cách kiểm tra xem khoảng thời gian giữa lần mua hàng hiện tại và lần mua hàng tiếp theo có nhỏ hơn hoặc bằng 30 ngày hay không.
*   **Tính Tính năng Lịch sử:** `DATEDIFF()` được sử dụng để tính toán `days_since_last_customer_market_date` (số ngày kể từ lần ghé thăm thị trường cuối cùng của khách hàng). Hàm này cũng được dùng để tính số lần khách hàng ghé thăm thị trường trong 30 ngày gần nhất, bằng cách lọc các lần truy cập trước đó nằm trong phạm vi 30 ngày (`DATEDIFF(cp.market_date, cma.market_date) <= 30`).