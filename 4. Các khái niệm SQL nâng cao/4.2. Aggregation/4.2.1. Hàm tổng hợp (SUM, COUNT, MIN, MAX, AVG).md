Tổng hợp là một bước thiết yếu, cho phép các nhà khoa học dữ liệu chuyển đổi dữ liệu chi tiết cấp hàng (row-level detail) thành các bản tóm tắt theo nhóm, phục vụ cho việc tạo báo cáo phân tích và xây dựng tập dữ liệu cho mô hình học máy.

### I. Tổng quan về Tổng hợp (Aggregation)

Tổng hợp trong SQL được thực hiện chủ yếu bằng mệnh đề **`GROUP BY`**, theo sau là các hàm tổng hợp.

*   **Mục đích:** Thay vì hiển thị từng bản ghi riêng lẻ, tổng hợp tạo ra một hàng cho mỗi tổ hợp giá trị duy nhất trong các cột được nhóm, sau đó áp dụng các hàm tổng hợp để tóm tắt các giá trị trong mỗi nhóm đó.
*   **Tính toán bên trong hàm:** Các phép toán số học có thể được thực hiện *bên trong* các hàm tổng hợp (ví dụ: `SUM(quantity * cost_to_customer_per_qty)`), trong đó phép tính cấp hàng được thực hiện trước khi tổng hợp xảy ra.

### II. Các Hàm Tổng hợp Cơ bản

#### 1. SUM() (Tính tổng)

Hàm `SUM()` được sử dụng để tính tổng của một cột số hoặc một phép tính số học trên các hàng trong mỗi nhóm.

*   **Ứng dụng:** Thường dùng để tính tổng chi tiêu hoặc tổng số lượng sản phẩm. Ví dụ, để tính tổng số tiền một khách hàng đã chi tiêu trong mỗi ngày thị trường (`market_date`), hàm `SUM()` được áp dụng cho phép tính giá (`quantity * cost_to_customer_per_qty`) sau khi nhóm theo ngày.
*   **Lưu ý:** `SUM()` cũng có thể được sử dụng bên trong các Hàm Cửa sổ (Window Functions) để tính **tổng chạy (running totals)**, hoặc tính tổng toàn bộ phân vùng (partition) và hiển thị kết quả đó trên mỗi hàng trong phân vùng.

#### 2. COUNT() (Đếm)

Hàm `COUNT()` được sử dụng để đếm số lượng hàng trong mỗi nhóm.

*   **`COUNT(*)`:** Đếm tất cả các hàng trong mỗi nhóm. Nếu không có nhóm, nó đếm tất cả các hàng trong tập kết quả.
*   **Thận trọng về Granularity:** Cần hiểu rõ tính hạt (granularity) của bảng gốc. Ví dụ, trong bảng `customer_purchases` (bảng ghi lại giao dịch mua hàng), `COUNT(*)` chỉ đếm số dòng giao dịch (line items), không phải tổng số lượng vật lý được mua (ví dụ: 1 dòng cho 3 quả cà chua).

#### 3. COUNT DISTINCT (Đếm duy nhất)

Hàm `COUNT(DISTINCT [cột])` đếm số lượng giá trị duy nhất trong một cột cụ thể trong mỗi nhóm.

*   **Ứng dụng:** Rất hữu ích khi muốn biết số lượng các mục khác nhau (distinct items) hoặc các thực thể duy nhất trong một nhóm. Ví dụ: `COUNT(DISTINCT product_id)` được sử dụng để xác định có bao nhiêu **loại sản phẩm khác nhau** (unique product IDs) đã được mua bởi mỗi khách hàng trên mỗi ngày thị trường.
*   **Kết hợp với Ngày/Thời gian:** `COUNT(DISTINCT market_date)` có thể được sử dụng để đếm số lượng ngày khác nhau mà một khách hàng đã thực hiện giao dịch mua hàng.

#### 4. MIN() và MAX() (Giá trị nhỏ nhất và lớn nhất)

Các hàm `MIN()` và `MAX()` trả về giá trị thấp nhất và cao nhất của một cột trong mỗi nhóm.

*   **Ứng dụng cho số:** Được sử dụng để tìm mức giá cao nhất (`MAX(original_price)`) hoặc thấp nhất (`MIN(original_price)`) của các mặt hàng trong mỗi danh mục sản phẩm.
*   **Ứng dụng cho Ngày:** `MIN(market_date)` và `MAX(market_date)` được dùng để tìm ngày sớm nhất (first purchase) và ngày muộn nhất (last purchase) của một khách hàng.
*   **Lưu ý quan trọng:** Nếu áp dụng `MIN()` hoặc `MAX()` cho một cột chuỗi (string column), nó sẽ trả về giá trị đầu tiên hoặc cuối cùng theo thứ tự bảng chữ cái, chứ **không phải** giá trị đi kèm với giá trị MIN/MAX của một cột khác. Để giải quyết vấn đề này, người ta phải sử dụng Hàm Cửa sổ (`ROW_NUMBER()` hoặc `RANK()`) và truy vấn con (subquery).

#### 5. AVG() (Tính trung bình)

Hàm `AVG()` tính giá trị trung bình của các bản ghi trong mỗi nhóm.

*   **Thận trọng về Granularity:** Giống như `SUM()` và `COUNT()`, cần cẩn thận về ý nghĩa của giá trị trung bình. Ví dụ, nếu một nhà cung cấp mang 100 quả cà chua ($1) và 1 bó hoa ($20), `AVG(original_price)` sẽ là $10.5, không phản ánh mức giá trung bình *thực tế* nếu tính cả số lượng.
*   **Tính trung bình trọng số:** Để tính giá trung bình thực tế, cần sử dụng các phép tính tổng hợp lồng nhau, ví dụ: `SUM(quantity * original_price) / SUM(quantity)`.
*   **Sử dụng như Hàm Cửa sổ:** `AVG()` cũng có thể được sử dụng như một hàm cửa sổ, được phân vùng theo một trường (ví dụ: `market_date`), để hiển thị giá trị trung bình của toàn bộ thị trường trên mỗi hàng, cho phép so sánh giá cá nhân với giá trung bình nhóm đó.

### III. Kỹ thuật Tổng hợp Nâng cao

Các hàm tổng hợp này thường được kết hợp với các kỹ thuật nâng cao khác:

*   **CASE Statements bên trong Hàm Tổng hợp:** Đây là một kỹ thuật mạnh mẽ cho phép **tổng hợp có điều kiện (conditional aggregation)**. Bằng cách đặt `CASE WHEN...THEN...ELSE END` bên trong hàm `SUM()`, người ta có thể chỉ tính tổng các giá trị thỏa mãn một điều kiện nhất định. Ví dụ: `SUM(CASE WHEN product_qty_type = "unit" THEN quantity ELSE 0 END)` chỉ tính tổng số lượng bán theo đơn vị.
*   **Mệnh đề HAVING:** Được sử dụng để lọc kết quả dựa trên các giá trị đã được tổng hợp bởi các hàm `SUM()`, `COUNT()`, v.v. (ví dụ: chỉ trả về các nhóm có tổng chi tiêu (`total_spent`) lớn hơn $50).