### I. Khái niệm và Mục đích của Tổng hợp có Điều kiện

Thông thường, các hàm tổng hợp như `SUM()` hoặc `COUNT()` sẽ được áp dụng cho **tất cả các hàng** trong một nhóm (group) được xác định bởi mệnh đề `GROUP BY`. Tuy nhiên, trong khoa học dữ liệu, thường cần phải tính tổng hoặc đếm các giá trị chỉ khi chúng thỏa mãn một điều kiện nhất định.

**Mục đích cốt lõi:** Kỹ thuật lồng CASE Statements bên trong hàm tổng hợp cho phép người dùng **chọn lọc các giá trị** trước khi thực hiện phép tính tổng hợp. Điều này cho phép tính toán các số liệu tổng hợp riêng biệt cho các danh mục con (subcategories) trong cùng một truy vấn, thay vì phải viết nhiều truy vấn hoặc tạo ra các truy vấn con phức tạp.

### II. Cú pháp và Cơ chế hoạt động

Cú pháp điển hình được sử dụng là `SUM(CASE WHEN [condition] THEN [value] ELSE 0 END)`.

#### 1. Cơ chế tính toán từng bước

1.  **Đánh giá điều kiện:** Đối với mỗi hàng trong tập dữ liệu (trước khi nhóm), `CASE WHEN` sẽ kiểm tra một điều kiện logic (ví dụ: `product_qty_type = "unit"`).
2.  **Trả về giá trị có điều kiện:**
    *   Nếu điều kiện đúng (`TRUE`), mệnh đề `THEN` sẽ trả về giá trị cần tổng hợp (ví dụ: cột `quantity`).
    *   Nếu điều kiện sai (`FALSE`), mệnh đề `ELSE` sẽ trả về `0`.
3.  **Thực hiện Tổng hợp:** Hàm `SUM()` bên ngoài sau đó sẽ tính tổng các giá trị (chủ yếu là 0 hoặc giá trị thực) được trả về bởi CASE Statement cho tất cả các hàng trong nhóm.

#### 2. Ví dụ chi tiết trong Tài liệu

Tài liệu minh họa ứng dụng của kỹ thuật này bằng cách giải quyết vấn đề tổng hợp số lượng sản phẩm mua vào, vốn bao gồm cả **đơn vị rời rạc** ("unit") và **khối lượng** ("lbs"), không nên cộng trực tiếp vào nhau.

Để giải quyết vấn đề này, thay vì tổng hợp cột `quantity` một cách đơn thuần (`SUM(quantity)`), truy vấn tạo ra ba cột tổng hợp riêng biệt, mỗi cột chỉ tính tổng số lượng dựa trên loại đơn vị cụ thể:

*   **Tổng số lượng theo đơn vị (units):**
    ```sql
    SUM(CASE WHEN product_qty_type = "unit" THEN quantity ELSE 0 END) AS qty_units_purchased
    ```
    Hàm này chỉ cộng `quantity` nếu `product_qty_type` là "unit", nếu không thì cộng `0`.
*   **Tổng số lượng theo khối lượng (lbs):**
    ```sql
    SUM(CASE WHEN product_qty_type = "lbs" THEN quantity ELSE 0 END) AS qty_lbs_purchased
    ```
    Tương tự, chỉ cộng `quantity` nếu `product_qty_type` là "lbs".
*   **Tổng số lượng theo đơn vị khác:**
    ```sql
    SUM(CASE WHEN product_qty_type NOT IN ("unit","lbs") THEN quantity ELSE 0 END) AS qty_other_purchased
    ```
    Cột này tổng hợp các đơn vị không phải "unit" hoặc "lbs", dự phòng cho các đơn vị có thể được thêm vào trong tương lai (ví dụ: ounces).

Để thực hiện phép tính này, truy vấn đã phải **JOIN** bảng `customer_purchases` với bảng `product` để lấy được cột `product_qty_type`. Sau đó, nó được nhóm (GROUP BY) theo `market_date` và `customer_id` để tóm tắt kết quả theo từng khách hàng/ngày.

### III. Ứng dụng trong Khoa học Dữ liệu và Báo cáo

Kỹ thuật `CASE` bên trong tổng hợp là một công cụ linh hoạt, được sử dụng trong nhiều ứng dụng phức tạp:

1.  **Tạo Số liệu cho Danh mục con (Subcategory Metrics):** Cho phép tính toán các số liệu như tổng doanh thu, số lượng bán, hoặc số lượng giao dịch cho các phân khúc nhỏ của dữ liệu (ví dụ: tính tổng chi tiêu cho các sản phẩm có giá trên $50).
2.  **Kỹ thuật Tính năng (Feature Engineering):** Trong việc xây dựng tập dữ liệu cho học máy, kỹ thuật này được sử dụng để tạo các tính năng (features) số hóa mới, chẳng hạn như đếm số lần một điều kiện cụ thể xảy ra trong lịch sử của một thực thể. Ví dụ: tính tổng số lần khách hàng mua sản phẩm từ một nhà cung cấp cụ thể (`vendor_id = 7`).
3.  **Đếm Khách hàng Mới/Cũ:** Kỹ thuật này được sử dụng để đếm số lượng khách hàng mới (là những người có ngày mua hàng hiện tại trùng với ngày mua hàng đầu tiên) so với tổng số khách hàng trong một tuần. Cú pháp sử dụng `COUNT(DISTINCT CASE WHEN [condition] THEN customer_id ELSE NULL END)` để chỉ đếm `customer_id` khi điều kiện (ví dụ: `market_date = first_purchase_date`) là đúng. Lưu ý, khi sử dụng `COUNT(DISTINCT...)`, việc trả về `NULL` trong mệnh đề `ELSE` là cần thiết vì hàm `COUNT(DISTINCT)` chỉ đếm các giá trị không phải `NULL`.

Tóm lại, việc sử dụng `SUM(CASE WHEN...)` vượt xa khả năng tổng hợp cơ bản của SQL, mang lại khả năng phân tích chi tiết và có điều kiện, cho phép nhà khoa học dữ liệu định hình dữ liệu thành các số liệu phức tạp và có ý nghĩa, thích hợp cho báo cáo chuyên sâu và mô hình hóa dự đoán.